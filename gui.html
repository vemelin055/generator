<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û–ø–∏—Å–∞–Ω–∏–π - Retro UI</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #00ff00;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #00ff00;
        }
        
        input[type="number"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 5px;
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 24px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        button:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 15px #00ff00;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #startBtn {
            background: #004400;
        }
        
        #stopBtn {
            background: #440000;
        }
        
        .log-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 340px;
            max-height: 60vh;
            background: rgba(0, 0, 0, 0.92);
            border: 2px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            overflow: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 999;
        }
        
        .log-panel.collapsed {
            transform: translateY(calc(100% - 46px));
            opacity: 0.7;
        }
        
        .log-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: rgba(0, 255, 0, 0.15);
            border-bottom: 1px solid #00ff00;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .log-panel-body {
            padding: 12px 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .output-line {
            margin: 2px 0;
            white-space: pre-wrap;
        }
        
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ffff; }
        .debug { color: #ffa500; }
        
        .progress-container {
            margin-top: 10px;
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 5px;
            height: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status-bar {
            margin-top: 10px;
            padding: 5px;
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 3px;
            text-align: center;
            font-weight: bold;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin: 0;">üöó –ì–ï–ù–ï–†–ê–¢–û–† –û–ü–ò–°–ê–ù–ò–ô –ê–í–¢–û–ó–ê–ü–ß–ê–°–¢–ï–ô</h1>
            <button onclick="window.location.href='/logout'" style="padding: 8px 16px; font-size: 0.9em; background: #440000; color: #ff0000; border: 2px solid #ff0000;">üö™ –í–´–•–û–î</button>
        </div>
        
        <div class="control-group">
            <label for="sheetUrl">üìä URL Google –¢–∞–±–ª–∏—Ü—ã:</label>
            <input type="text" id="sheetUrl" value="https://docs.google.com/spreadsheets/d/1Accfa2Ln4RuUchSVs-71Gd2yMlPBt_7hvLaJl6DwcPU/edit?gid=1970407067#gid=1970407067">
            
            <label for="sheetName">üìù –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞:</label>
            <input type="text" id="sheetName" value="–ö–æ–º–¢–µ—Ö–ê–≤—Ç–æ">
            
            <label for="headerRow">üìë –°—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:</label>
            <input type="number" id="headerRow" min="1" max="100" value="1" style="width: 100px;">
            <small style="color: #00ff00; display: block; margin-top: 5px;">–ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1, –¥–ª—è –ú–∞–≤–∏–∫–æ/–ì–ü –º–æ–∂–µ—Ç –±—ã—Ç—å 9)</small>
        </div>
        
        <div class="control-group">
            <label>üìã –í—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫:</label>
            <label for="articleColumn" style="margin-top: 10px;">–ê—Ä—Ç–∏–∫—É–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <input type="text" id="articleColumn" value="–ê—Ä—Ç–∏–∫—É–ª" placeholder="(–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)" style="width: 100%; padding: 10px; border: 2px solid #00ff00; background: #000; color: #00ff00; font-family: 'Courier New', monospace; border-radius: 5px; margin-bottom: 10px;">
            
            <label for="nameColumn">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="text" id="nameColumn" value="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" style="width: 100%; padding: 10px; border: 2px solid #00ff00; background: #000; color: #00ff00; font-family: 'Courier New', monospace; border-radius: 5px; margin-bottom: 10px;">
            
            <label for="descriptionColumn">–û–ø–∏—Å–∞–Ω–∏–µ (–∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏):</label>
            <input type="text" id="descriptionColumn" value="–û–ø–∏—Å–∞–Ω–∏–µ" placeholder="(—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É)" style="width: 100%; padding: 10px; border: 2px solid #00ff00; background: #000; color: #00ff00; font-family: 'Courier New', monospace; border-radius: 5px; margin-bottom: 10px;">
            <small style="color: #00ff00; display: block; margin-top: 5px;">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫. –û—Å—Ç–∞–≤—å—Ç–µ –ê—Ä—Ç–∏–∫—É–ª –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω. –û—Å—Ç–∞–≤—å—Ç–µ –û–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É.</small>
        </div>
        
        <div class="control-group">
            <button onclick="previewSheet()">üëÅÔ∏è –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –î–ê–ù–ù–´–•</button>
            <button onclick="loadColumns()" style="margin-left: 10px;">üîÑ –ó–ê–ì–†–£–ó–ò–¢–¨ –ö–û–õ–û–ù–ö–ò</button>
        </div>
        
        <div class="control-group">
            <label for="startLine">üìà –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:</label>
            <div class="slider-container">
                <input type="range" id="startLineSlider" min="2" max="1000" value="913" step="1">
                <input type="number" id="startLine" min="2" max="1000" value="913">
            </div>
        </div>
        
        <div class="control-group">
            <label for="endLine">üìâ –ö–æ–Ω–µ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:</label>
            <div class="slider-container">
                <input type="range" id="endLineSlider" min="2" max="1000" value="917" step="1">
                <input type="number" id="endLine" min="2" max="1000" value="917">
            </div>
        </div>
        
        <div class="control-group">
            <label for="prompt">üìù –ü—Ä–æ–º–ø—Ç:</label>
            <textarea id="prompt">–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç—è–º –∏ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥. –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ:
- –ê—Ä—Ç–∏–∫—É–ª: {article}
- –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: {name}

–ó–∞–¥–∞—á–∞:
1. –ù–∞–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ HTML-–æ–ø–∏—Å–∞–Ω–∏–µ (h2/h3/p/ul/li/strong) –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
2. –°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.
3. –£–∫–∞–∂–∏ –∞—Ä—Ç–∏–∫—É–ª –∏ –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≥–æ–¥—ã.
4. –û–±—ä—ë–º 90‚Äì140 —Å–ª–æ–≤. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏ —Å—Å—ã–ª–∫–∏.</textarea>
        </div>
        
        <div class="button-group">
            <button id="startBtn" onclick="startGeneration()">‚ñ∂Ô∏è –ù–ê–ß–ê–¢–¨ –ì–ï–ù–ï–†–ê–¶–ò–Æ</button>
            <button id="stopBtn" onclick="stopGeneration()" disabled>‚èπÔ∏è –û–°–¢–ê–ù–û–í–ò–¢–¨</button>
        </div>
        
        <div class="status-bar">
            <span id="status">üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <!-- Preview Modal -->
        <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 2px solid #00ff00; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow: auto;">
                <h3 style="color: #00ff00; margin-bottom: 15px;">üìä –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –î–ê–ù–ù–´–•</h3>
                <div id="previewContent" style="color: #00ff00; font-family: 'Courier New', monospace;"></div>
                <button onclick="closePreview()" style="margin-top: 15px; padding: 10px 20px; background: #440000; color: #00ff00; border: 1px solid #00ff00; cursor: pointer;">–ó–ê–ö–†–´–¢–¨</button>
            </div>
        </div>
        
        <!-- Success Modal -->
        <div id="successModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 3px solid #00ff00; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center; box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);">
                <h2 style="color: #00ff00; margin-bottom: 20px; font-size: 2em;">‚úÖ –£–°–ü–ï–®–ù–û!</h2>
                <div id="successContent" style="color: #00ff00; font-family: 'Courier New', monospace; margin-bottom: 20px; font-size: 1.2em;"></div>
                <button onclick="closeSuccessModal()" style="padding: 12px 30px; background: #004400; color: #00ff00; border: 2px solid #00ff00; cursor: pointer; font-size: 1.1em; font-weight: bold; border-radius: 5px;">–û–ö</button>
            </div>
        </div>
        
        <!-- Error Modal -->
        <div id="errorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1002;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 3px solid #ff0000; padding: 30px; border-radius: 10px; max-width: 600px; text-align: center; box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);">
                <h2 style="color: #ff0000; margin-bottom: 20px; font-size: 2em;">‚ùå –û–®–ò–ë–ö–ê!</h2>
                <div id="errorContent" style="color: #ff0000; font-family: 'Courier New', monospace; margin-bottom: 20px; font-size: 1.1em; text-align: left; max-height: 300px; overflow-y: auto; padding: 10px; background: rgba(255, 0, 0, 0.1); border: 1px solid #ff0000; border-radius: 5px;"></div>
                <button onclick="closeErrorModal()" style="padding: 12px 30px; background: #440000; color: #ff0000; border: 2px solid #ff0000; cursor: pointer; font-size: 1.1em; font-weight: bold; border-radius: 5px;">–û–ö</button>
            </div>
        </div>
    </div>
    
    <div class="log-panel" id="logPanel">
        <div class="log-panel-header" onclick="toggleLogPanel()">
            <span>üìú –õ–æ–≥–∏</span>
            <span id="logToggleIcon">‚ñæ</span>
        </div>
        <div class="log-panel-body" id="output">
            <div class="output-line info">üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ –ù–ê–ß–ê–¢–¨ –¥–ª—è –Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...</div>
        </div>
    </div>

    <script>
        let isGenerating = false;
        let processId = null;
        let logPanelCollapsed = false;
        let lastRequestId = 0;
        let generationStartTime = null;
        let processedCount = 0;
        let errorMessages = [];
        
        // Sync sliders and number inputs
        document.getElementById('startLineSlider').addEventListener('input', function() {
            document.getElementById('startLine').value = this.value;
        });
        
        document.getElementById('startLine').addEventListener('input', function() {
            document.getElementById('startLineSlider').value = this.value;
        });
        
        document.getElementById('endLineSlider').addEventListener('input', function() {
            document.getElementById('endLine').value = this.value;
        });
        
        document.getElementById('endLine').addEventListener('input', function() {
            document.getElementById('endLineSlider').value = this.value;
        });
        
        function getTimestamp() {
            return new Date().toLocaleTimeString('ru-RU', { hour12: false });
        }
        
        function addOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = `[${getTimestamp()}][${type.toUpperCase()}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
            if (type === 'error') {
                console.error(message);
            } else if (type === 'warning') {
                console.warn(message);
            } else {
                console.log(message);
            }
        }
        
        function addDebug(message) {
            addOutput(message, 'debug');
        }
        
        function updateStatus(message, isBlinking = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isBlinking ? 'blink' : '';
        }
        
        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }
        
        function toggleLogPanel() {
            const panel = document.getElementById('logPanel');
            const icon = document.getElementById('logToggleIcon');
            logPanelCollapsed = !logPanelCollapsed;
            if (logPanelCollapsed) {
                panel.classList.add('collapsed');
                icon.textContent = '‚ñ¥';
            } else {
                panel.classList.remove('collapsed');
                icon.textContent = '‚ñæ';
            }
        }
        
        function loadColumns() {
            const requestId = ++lastRequestId;
            const sheetUrl = document.getElementById('sheetUrl').value.trim();
            const sheetName = document.getElementById('sheetName').value.trim();
            const headerRow = parseInt(document.getElementById('headerRow').value) || 1;
            
            addOutput(`üîÑ [req:${requestId}] –ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫...`, 'info');
            
            fetch('/api/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sheet_url: sheetUrl,
                    sheet_name: sheetName,
                    header_row: headerRow
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–æ–Ω–æ–∫: ${data.error}`, 'error');
                    return;
                }
                
                // Populate column text inputs
                const articleInput = document.getElementById('articleColumn');
                const nameInput = document.getElementById('nameColumn');
                const descriptionInput = document.getElementById('descriptionColumn');
                
                // Set defaults if available in headers
                if (data.headers.includes('–ê—Ä—Ç–∏–∫—É–ª')) {
                    articleInput.value = '–ê—Ä—Ç–∏–∫—É–ª';
                } else {
                    articleInput.value = '';
                }
                
                if (data.headers.includes('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ')) {
                    nameInput.value = '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ';
                } else if (data.headers.length > 0) {
                    // Use first available column as default for name
                    nameInput.value = data.headers[0].trim() || '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ';
                }
                
                if (data.headers.includes('–û–ø–∏—Å–∞–Ω–∏–µ')) {
                    descriptionInput.value = '–û–ø–∏—Å–∞–Ω–∏–µ';
                } else {
                    descriptionInput.value = '';
                }
                
                addOutput(`‚úÖ [req:${requestId}] –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–ª–æ–Ω–æ–∫: ${data.headers.length}`, 'success');
            })
            .catch(error => {
                addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–æ–Ω–æ–∫: ${error.message}`, 'error');
            });
        }
        
        function previewSheet() {
            const requestId = ++lastRequestId;
            const sheetUrl = document.getElementById('sheetUrl').value.trim();
            const sheetName = document.getElementById('sheetName').value.trim();
            const headerRow = parseInt(document.getElementById('headerRow').value) || 1;
            
            addOutput(`üîç [req:${requestId}] –ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (${sheetName})...`, 'info');
            addDebug(`req:${requestId} payload: ${JSON.stringify({ sheet_url: sheetUrl, sheet_name: sheetName, header_row: headerRow })}`);
            
            fetch('/api/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sheet_url: sheetUrl,
                    sheet_name: sheetName,
                    header_row: headerRow
                })
            })
            .then(response => {
                addDebug(`req:${requestId} /api/preview status ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${data.error}`, 'error');
                    return;
                }
                
                const previewContent = document.getElementById('previewContent');
                const modal = document.getElementById('previewModal');
                
                // Format the preview data as a table
                let html = '<table style="width: 100%; border-collapse: collapse; color: #00ff00;">';
                
                // Add headers
                html += '<tr>';
                data.headers.forEach(header => {
                    html += `<th style="border: 1px solid #00ff00; padding: 8px; text-align: left;">${header}</th>`;
                });
                html += '</tr>';
                
                // Add sample rows (first 5 rows)
                data.rows.slice(0, 5).forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td style="border: 1px solid #00ff00; padding: 8px;">${cell || ''}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                html += `<p style="margin-top: 10px;">üìã –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: ${data.rows.length}</p>`;
                
                previewContent.innerHTML = html;
                modal.style.display = 'block';
                addOutput(`‚úÖ [req:${requestId}] –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
            })
            .catch(error => {
                addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${error.message}`, 'error');
            });
        }
        
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }
        
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }
        
        function showErrorModal(errorMessage) {
            const modal = document.getElementById('errorModal');
            const content = document.getElementById('errorContent');
            // Format error message with line breaks
            const formattedError = errorMessage.replace(/\n/g, '<br>').replace(/Traceback/g, '<strong>Traceback</strong>');
            content.innerHTML = `<pre style="color: #ff0000; white-space: pre-wrap; font-family: 'Courier New', monospace;">${formattedError}</pre>`;
            modal.style.display = 'block';
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds.toFixed(1)} —Å–µ–∫`;
            }
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins} –º–∏–Ω ${secs} —Å–µ–∫`;
        }
        
        function showSuccessModal(processedCount, duration) {
            const modal = document.getElementById('successModal');
            const content = document.getElementById('successContent');
            content.innerHTML = `
                <p>‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: <strong>${processedCount}</strong></p>
                <p>‚è±Ô∏è –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: <strong>${formatDuration(duration)}</strong></p>
            `;
            modal.style.display = 'block';
        }
        
        function startGeneration() {
            if (isGenerating) return;
            
            const requestId = ++lastRequestId;
            const sheetUrl = document.getElementById('sheetUrl').value.trim();
            const sheetName = document.getElementById('sheetName').value.trim();
            const headerRow = parseInt(document.getElementById('headerRow').value) || 1;
            const articleColumn = document.getElementById('articleColumn').value.trim();
            const nameColumn = document.getElementById('nameColumn').value.trim();
            const descriptionColumn = document.getElementById('descriptionColumn').value.trim();
            const startLine = parseInt(document.getElementById('startLine').value);
            const endLine = parseInt(document.getElementById('endLine').value);
            const prompt = document.getElementById('prompt').value.trim();
            
            if (startLine >= endLine) {
                addOutput('‚ùå –û—à–∏–±–∫–∞: –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π', 'error');
                return;
            }
            
            if (!sheetUrl || !sheetName) {
                addOutput('‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ URL —Ç–∞–±–ª–∏—Ü—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞', 'error');
                return;
            }
            
            if (!nameColumn) {
                addOutput('‚ùå –û—à–∏–±–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)', 'error');
                return;
            }
            
            // Empty articleColumn means "don't use article" - that's allowed
            // Empty descriptionColumn means "create new column" - that's allowed
            
            isGenerating = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            // Start timing and reset counters
            generationStartTime = Date.now();
            processedCount = 0;
            errorMessages = [];
            const startTimeStr = new Date().toLocaleTimeString('ru-RU');
            addOutput(`üîß [req:${requestId}] –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ–ø–∏—Å–∞–Ω–∏–π... [${startTimeStr}]`, 'info');
            updateStatus('üü° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...', true);
            updateProgress(0);
            const payload = {
                sheet_url: sheetUrl,
                sheet_name: sheetName,
                header_row: headerRow,
                article_column: articleColumn,
                name_column: nameColumn,
                description_column: descriptionColumn,
                start_row: startLine,
                end_row: endLine,
                prompt: prompt,
                force: false,
                dry_run: false
            };
            addDebug(`req:${requestId} payload: ${JSON.stringify(payload)}`);
            
            // Call backend API to start generation
            fetch('/api/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                addDebug(`req:${requestId} /api/start status ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    addOutput(`‚ùå [req:${requestId}] ${data.error}`, 'error');
                    stopGeneration();
                    return;
                }
                
                addOutput(`‚úÖ [req:${requestId}] –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å —Å—Ç—Ä–æ–∫–∏ ${data.start_row} –¥–æ ${data.end_row}`, 'success');
                
                // Set up log streaming
                const eventSource = new EventSource('/api/logs');
                addDebug(`req:${requestId} EventSource –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è...`);
                
                eventSource.onopen = function() {
                    addDebug(`req:${requestId} EventSource –æ—Ç–∫—Ä—ã—Ç`);
                };
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.keep_alive) return;
                    
                    addOutput(data.message, data.type || 'info');
                    
                    // Collect error messages
                    if (data.message.includes('‚ùå') || data.type === 'error' || data.message.includes('Error') || data.message.includes('Traceback')) {
                        errorMessages.push(data.message);
                    }
                    
                    // Track processed count
                    if (data.message.includes('‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ') || data.message.includes('‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ')) {
                        processedCount++;
                    }
                    
                    // Update progress based on log messages
                    const progressMatch = data.message.match(/–°—Ç—Ä–æ–∫–∞ (\d+)/) || data.message.match(/row (\d+)/i);
                    if (progressMatch) {
                        const currentRow = parseInt(progressMatch[1]);
                        const progress = ((currentRow - startLine) / (endLine - startLine)) * 100;
                        updateProgress(Math.min(100, progress));
                    }
                    
                    // Check for completion - multiple patterns
                    const completionPatterns = [
                        /–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫[:\s]+(\d+)/i,
                        /processed[:\s]+(\d+)/i,
                        /–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞/i,
                        /–∑–∞–≤–µ—Ä—à–µ–Ω–∞/i,
                        /completed/i
                    ];
                    
                    let isCompleted = false;
                    let extractedCount = null;
                    
                    for (const pattern of completionPatterns) {
                        const match = data.message.match(pattern);
                        if (match) {
                            isCompleted = true;
                            if (match[1]) {
                                extractedCount = parseInt(match[1]);
                            }
                            break;
                        }
                    }
                    
                    // Also check if message contains completion indicators
                    if (!isCompleted) {
                        isCompleted = data.message.includes('‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞') || 
                                     data.message.includes('‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫') ||
                                     (data.type === 'success' && data.message.includes('–∑–∞–≤–µ—Ä—à–µ–Ω–∞'));
                    }
                    
                    if (isCompleted) {
                        const endTime = Date.now();
                        const duration = (endTime - generationStartTime) / 1000; // in seconds
                        const endTimeStr = new Date().toLocaleTimeString('ru-RU');
                        
                        // Determine final count: use extracted from message, or tracked count, or '?'
                        let finalCount = extractedCount;
                        if (!finalCount) {
                            // Try to extract from message
                            const countMatch = data.message.match(/(\d+)/);
                            if (countMatch) {
                                finalCount = parseInt(countMatch[1]);
                            }
                        }
                        // Use tracked count if message doesn't have it
                        if (!finalCount && processedCount > 0) {
                            finalCount = processedCount;
                        }
                        if (!finalCount) {
                            finalCount = '?';
                        }
                        
                        addOutput(`‚è±Ô∏è [req:${requestId}] –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${formatDuration(duration)} [${endTimeStr}]`, 'success');
                        addOutput(`‚úÖ [req:${requestId}] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`, 'success');
                        
                        // Reset timing
                        generationStartTime = null;
                        
                        stopGeneration();
                        updateStatus('üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                        updateProgress(100);
                        eventSource.close();
                        
                        // Show success modal for all sheets (–ö–æ–º–¢–µ—Ö–ê–≤—Ç–æ, –ú–∞–≤–∏–∫–æ, –ì–ü)
                        showSuccessModal(finalCount, duration);
                    }
                    
                    // Check for errors - show modal if process exited with error
                    if (data.message.includes('‚ùå Process exited with code') || 
                        (data.message.includes('‚ùå') && data.message.includes('exited'))) {
                        updateStatus('üî¥ –û—à–∏–±–∫–∞');
                        addDebug(`req:${requestId} EventSource –∑–∞–∫—Ä—ã—Ç –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞`);
                        eventSource.close();
                        stopGeneration();
                        
                        // Show error modal with collected error messages
                        const errorText = errorMessages.length > 0 
                            ? errorMessages.join('\n\n') 
                            : data.message;
                        showErrorModal(errorText);
                    } else if (data.message.includes('‚ùå') || data.type === 'error') {
                        updateStatus('üî¥ –û—à–∏–±–∫–∞');
                        // Don't close immediately, collect more errors
                    }
                };
                
                eventSource.onerror = function() {
                    const errorMsg = `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º (EventSource)`;
                    addOutput(`‚ùå [req:${requestId}] ${errorMsg}`, 'error');
                    addDebug(`req:${requestId} EventSource onerror`);
                    stopGeneration();
                    
                    // Show error modal
                    const errorText = errorMessages.length > 0 
                        ? errorMessages.join('\n\n') + '\n\n' + errorMsg
                        : errorMsg;
                    showErrorModal(errorText);
                };
                
                // Store event source for cleanup
                window.currentEventSource = eventSource;
            })
            .catch(error => {
                const errorMsg = `–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${error.message}`;
                addOutput(`‚ùå [req:${requestId}] ${errorMsg}`, 'error');
                stopGeneration();
                showErrorModal(errorMsg);
            });
        }
        
        function stopGeneration() {
            if (!isGenerating) return;
            
            isGenerating = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            // Reset timing if generation was stopped manually
            if (generationStartTime) {
                const duration = (Date.now() - generationStartTime) / 1000;
                addOutput(`‚èπÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${formatDuration(duration)}`, 'warning');
                generationStartTime = null;
            }
            
            // Close event source if exists
            if (window.currentEventSource) {
                window.currentEventSource.close();
                window.currentEventSource = null;
            }
            
            // Call backend API to stop generation
            const requestId = ++lastRequestId;
            fetch('/api/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                addDebug(`req:${requestId} /api/stop status ${response.status}`);
                return response.json();
            })
            .then(data => {
                addOutput(`‚èπÔ∏è [req:${requestId}] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º`, 'warning');
                updateStatus('üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                updateProgress(0);
            })
            .catch(error => {
                addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${error.message}`, 'error');
                updateStatus('üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                updateProgress(0);
            });
        }
        
        // Initialize
        addOutput('üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û–ø–∏—Å–∞–Ω–∏–π v1.0 - Retro Edition', 'info');
        addOutput('üìä –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∫ —Å–µ—Ä–≤–µ—Ä—É', 'info');
        
        // Close modal on outside click
        document.getElementById('previewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePreview();
            }
        });
        
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });
        
        document.getElementById('errorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeErrorModal();
            }
        });
    </script>
</body>
</html>
