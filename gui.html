<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û–ø–∏—Å–∞–Ω–∏–π - Retro UI</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #00ff00;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #00ff00;
        }
        
        input[type="number"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 5px;
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 24px;
            border: 2px solid #00ff00;
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        button:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 15px #00ff00;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #startBtn {
            background: #004400;
        }
        
        #stopBtn {
            background: #440000;
        }
        
        .log-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 340px;
            max-height: 60vh;
            background: rgba(0, 0, 0, 0.92);
            border: 2px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            overflow: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 999;
        }
        
        .log-panel.collapsed {
            transform: translateY(calc(100% - 46px));
            opacity: 0.7;
        }
        
        .log-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: rgba(0, 255, 0, 0.15);
            border-bottom: 1px solid #00ff00;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .log-panel-body {
            padding: 12px 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .output-line {
            margin: 2px 0;
            white-space: pre-wrap;
        }
        
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ffff; }
        .debug { color: #ffa500; }
        
        .progress-container {
            margin-top: 10px;
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 5px;
            height: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status-bar {
            margin-top: 10px;
            padding: 5px;
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 3px;
            text-align: center;
            font-weight: bold;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó –ì–ï–ù–ï–†–ê–¢–û–† –û–ü–ò–°–ê–ù–ò–ô –ê–í–¢–û–ó–ê–ü–ß–ê–°–¢–ï–ô</h1>
        
        <div class="control-group">
            <label for="sheetUrl">üìä URL Google –¢–∞–±–ª–∏—Ü—ã:</label>
            <input type="text" id="sheetUrl" value="https://docs.google.com/spreadsheets/d/1Accfa2Ln4RuUchSVs-71Gd2yMlPBt_7hvLaJl6DwcPU/edit?gid=1970407067#gid=1970407067">
            
            <label for="sheetName">üìù –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞:</label>
            <input type="text" id="sheetName" value="–ö–æ–º–¢–µ—Ö–ê–≤—Ç–æ">
            
            <label for="columnName">üìã –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
            <input type="text" id="columnName" value="–û–ø–∏—Å–∞–Ω–∏–µ">
        </div>
        
        <div class="control-group">
            <button onclick="previewSheet()">üëÅÔ∏è –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –î–ê–ù–ù–´–•</button>
        </div>
        
        <div class="control-group">
            <label for="startLine">üìà –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:</label>
            <div class="slider-container">
                <input type="range" id="startLineSlider" min="2" max="1000" value="913" step="1">
                <input type="number" id="startLine" min="2" max="1000" value="913">
            </div>
        </div>
        
        <div class="control-group">
            <label for="endLine">üìâ –ö–æ–Ω–µ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:</label>
            <div class="slider-container">
                <input type="range" id="endLineSlider" min="2" max="1000" value="917" step="1">
                <input type="number" id="endLine" min="2" max="1000" value="917">
            </div>
        </div>
        
        <div class="control-group">
            <label for="prompt">üìù –ü—Ä–æ–º–ø—Ç:</label>
            <textarea id="prompt">–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç—è–º –∏ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥. –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ:
- –ê—Ä—Ç–∏–∫—É–ª: {article}
- –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: {name}

–ó–∞–¥–∞—á–∞:
1. –ù–∞–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ HTML-–æ–ø–∏—Å–∞–Ω–∏–µ (h2/h3/p/ul/li/strong) –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
2. –°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∑–∞–ø—á–∞—Å—Ç–∏, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.
3. –£–∫–∞–∂–∏ –∞—Ä—Ç–∏–∫—É–ª –∏ –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≥–æ–¥—ã.
4. –û–±—ä—ë–º 90‚Äì140 —Å–ª–æ–≤. –ù–µ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏ —Å—Å—ã–ª–∫–∏.</textarea>
        </div>
        
        <div class="button-group">
            <button id="startBtn" onclick="startGeneration()">‚ñ∂Ô∏è –ù–ê–ß–ê–¢–¨ –ì–ï–ù–ï–†–ê–¶–ò–Æ</button>
            <button id="stopBtn" onclick="stopGeneration()" disabled>‚èπÔ∏è –û–°–¢–ê–ù–û–í–ò–¢–¨</button>
        </div>
        
        <div class="status-bar">
            <span id="status">üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</span>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <!-- Preview Modal -->
        <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 2px solid #00ff00; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow: auto;">
                <h3 style="color: #00ff00; margin-bottom: 15px;">üìä –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –î–ê–ù–ù–´–•</h3>
                <div id="previewContent" style="color: #00ff00; font-family: 'Courier New', monospace;"></div>
                <button onclick="closePreview()" style="margin-top: 15px; padding: 10px 20px; background: #440000; color: #00ff00; border: 1px solid #00ff00; cursor: pointer;">–ó–ê–ö–†–´–¢–¨</button>
            </div>
        </div>
        
        <!-- Success Modal -->
        <div id="successModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 3px solid #00ff00; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center; box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);">
                <h2 style="color: #00ff00; margin-bottom: 20px; font-size: 2em;">‚úÖ –£–°–ü–ï–®–ù–û!</h2>
                <div id="successContent" style="color: #00ff00; font-family: 'Courier New', monospace; margin-bottom: 20px; font-size: 1.2em;"></div>
                <button onclick="closeSuccessModal()" style="padding: 12px 30px; background: #004400; color: #00ff00; border: 2px solid #00ff00; cursor: pointer; font-size: 1.1em; font-weight: bold; border-radius: 5px;">–û–ö</button>
            </div>
        </div>
    </div>
    
    <div class="log-panel" id="logPanel">
        <div class="log-panel-header" onclick="toggleLogPanel()">
            <span>üìú –õ–æ–≥–∏</span>
            <span id="logToggleIcon">‚ñæ</span>
        </div>
        <div class="log-panel-body" id="output">
            <div class="output-line info">üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ –ù–ê–ß–ê–¢–¨ –¥–ª—è –Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...</div>
        </div>
    </div>

    <script>
        let isGenerating = false;
        let processId = null;
        let logPanelCollapsed = false;
        let lastRequestId = 0;
        let generationStartTime = null;
        
        // Sync sliders and number inputs
        document.getElementById('startLineSlider').addEventListener('input', function() {
            document.getElementById('startLine').value = this.value;
        });
        
        document.getElementById('startLine').addEventListener('input', function() {
            document.getElementById('startLineSlider').value = this.value;
        });
        
        document.getElementById('endLineSlider').addEventListener('input', function() {
            document.getElementById('endLine').value = this.value;
        });
        
        document.getElementById('endLine').addEventListener('input', function() {
            document.getElementById('endLineSlider').value = this.value;
        });
        
        function getTimestamp() {
            return new Date().toLocaleTimeString('ru-RU', { hour12: false });
        }
        
        function addOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = `[${getTimestamp()}][${type.toUpperCase()}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
            if (type === 'error') {
                console.error(message);
            } else if (type === 'warning') {
                console.warn(message);
            } else {
                console.log(message);
            }
        }
        
        function addDebug(message) {
            addOutput(message, 'debug');
        }
        
        function updateStatus(message, isBlinking = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isBlinking ? 'blink' : '';
        }
        
        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }
        
        function toggleLogPanel() {
            const panel = document.getElementById('logPanel');
            const icon = document.getElementById('logToggleIcon');
            logPanelCollapsed = !logPanelCollapsed;
            if (logPanelCollapsed) {
                panel.classList.add('collapsed');
                icon.textContent = '‚ñ¥';
            } else {
                panel.classList.remove('collapsed');
                icon.textContent = '‚ñæ';
            }
        }
        
        function previewSheet() {
            const requestId = ++lastRequestId;
            const sheetUrl = document.getElementById('sheetUrl').value;
            const sheetName = document.getElementById('sheetName').value;
            
            addOutput(`üîç [req:${requestId}] –ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (${sheetName})...`, 'info');
            addDebug(`req:${requestId} payload: ${JSON.stringify({ sheet_url: sheetUrl, sheet_name: sheetName })}`);
            
            fetch('/api/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sheet_url: sheetUrl,
                    sheet_name: sheetName
                })
            })
            .then(response => {
                addDebug(`req:${requestId} /api/preview status ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${data.error}`, 'error');
                    return;
                }
                
                const previewContent = document.getElementById('previewContent');
                const modal = document.getElementById('previewModal');
                
                // Format the preview data as a table
                let html = '<table style="width: 100%; border-collapse: collapse; color: #00ff00;">';
                
                // Add headers
                html += '<tr>';
                data.headers.forEach(header => {
                    html += `<th style="border: 1px solid #00ff00; padding: 8px; text-align: left;">${header}</th>`;
                });
                html += '</tr>';
                
                // Add sample rows (first 5 rows)
                data.rows.slice(0, 5).forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td style="border: 1px solid #00ff00; padding: 8px;">${cell || ''}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                html += `<p style="margin-top: 10px;">üìã –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: ${data.rows.length}</p>`;
                
                previewContent.innerHTML = html;
                modal.style.display = 'block';
                addOutput(`‚úÖ [req:${requestId}] –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
            })
            .catch(error => {
                addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${error.message}`, 'error');
            });
        }
        
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds.toFixed(1)} —Å–µ–∫`;
            }
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins} –º–∏–Ω ${secs} —Å–µ–∫`;
        }
        
        function showSuccessModal(processedCount, duration) {
            const modal = document.getElementById('successModal');
            const content = document.getElementById('successContent');
            content.innerHTML = `
                <p>‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: <strong>${processedCount}</strong></p>
                <p>‚è±Ô∏è –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: <strong>${formatDuration(duration)}</strong></p>
            `;
            modal.style.display = 'block';
        }
        
        function startGeneration() {
            if (isGenerating) return;
            
            const requestId = ++lastRequestId;
            const sheetUrl = document.getElementById('sheetUrl').value;
            const sheetName = document.getElementById('sheetName').value;
            const columnName = document.getElementById('columnName').value;
            const startLine = parseInt(document.getElementById('startLine').value);
            const endLine = parseInt(document.getElementById('endLine').value);
            const prompt = document.getElementById('prompt').value;
            
            if (startLine >= endLine) {
                addOutput('‚ùå –û—à–∏–±–∫–∞: –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –∫–æ–Ω–µ—á–Ω–æ–π', 'error');
                return;
            }
            
            if (!sheetUrl || !sheetName || !columnName) {
                addOutput('‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Google –¢–∞–±–ª–∏—Ü—ã', 'error');
                return;
            }
            
            isGenerating = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            // Start timing
            generationStartTime = Date.now();
            const startTimeStr = new Date().toLocaleTimeString('ru-RU');
            addOutput(`üîß [req:${requestId}] –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ–ø–∏—Å–∞–Ω–∏–π... [${startTimeStr}]`, 'info');
            updateStatus('üü° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...', true);
            updateProgress(0);
            const payload = {
                sheet_url: sheetUrl,
                sheet_name: sheetName,
                column_name: columnName,
                start_row: startLine,
                end_row: endLine,
                prompt: prompt,
                force: false,
                dry_run: false
            };
            addDebug(`req:${requestId} payload: ${JSON.stringify(payload)}`);
            
            // Call backend API to start generation
            fetch('/api/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                addDebug(`req:${requestId} /api/start status ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    addOutput(`‚ùå [req:${requestId}] ${data.error}`, 'error');
                    stopGeneration();
                    return;
                }
                
                addOutput(`‚úÖ [req:${requestId}] –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å —Å—Ç—Ä–æ–∫–∏ ${data.start_row} –¥–æ ${data.end_row}`, 'success');
                
                // Set up log streaming
                const eventSource = new EventSource('/api/logs');
                addDebug(`req:${requestId} EventSource –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è...`);
                
                eventSource.onopen = function() {
                    addDebug(`req:${requestId} EventSource –æ—Ç–∫—Ä—ã—Ç`);
                };
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.keep_alive) return;
                    
                    addOutput(data.message, data.type || 'info');
                    
                    // Update progress based on log messages
                    const progressMatch = data.message.match(/–°—Ç—Ä–æ–∫–∞ (\d+)/) || data.message.match(/row (\d+)/i);
                    if (progressMatch) {
                        const currentRow = parseInt(progressMatch[1]);
                        const progress = ((currentRow - startLine) / (endLine - startLine)) * 100;
                        updateProgress(Math.min(100, progress));
                    }
                    
                    // Check for completion
                    if (data.message.includes('–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫') || data.message.includes('completed')) {
                        const endTime = Date.now();
                        const duration = (endTime - generationStartTime) / 1000; // in seconds
                        const endTimeStr = new Date().toLocaleTimeString('ru-RU');
                        
                        // Extract processed count from message
                        const countMatch = data.message.match(/–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫[:\s]+(\d+)/i) || 
                                         data.message.match(/processed[:\s]+(\d+)/i) ||
                                         data.message.match(/(\d+)/);
                        const processedCount = countMatch ? countMatch[1] : '?';
                        
                        addOutput(`‚è±Ô∏è [req:${requestId}] –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${formatDuration(duration)} [${endTimeStr}]`, 'success');
                        addOutput(`‚úÖ [req:${requestId}] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`, 'success');
                        
                        // Reset timing
                        generationStartTime = null;
                        
                        stopGeneration();
                        updateStatus('üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                        updateProgress(100);
                        eventSource.close();
                        
                        // Show success modal
                        showSuccessModal(processedCount, duration);
                    }
                    
                    // Check for errors
                    if (data.message.includes('‚ùå') || data.type === 'error') {
                        updateStatus('üî¥ –û—à–∏–±–∫–∞');
                        addDebug(`req:${requestId} EventSource –∑–∞–∫—Ä—ã—Ç –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ª–æ–≥–∞`);
                        eventSource.close();
                    }
                };
                
                eventSource.onerror = function() {
                    addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º (EventSource)`, 'error');
                    addDebug(`req:${requestId} EventSource onerror`);
                    stopGeneration();
                };
                
                // Store event source for cleanup
                window.currentEventSource = eventSource;
            })
            .catch(error => {
                addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${error.message}`, 'error');
                stopGeneration();
            });
        }
        
        function stopGeneration() {
            if (!isGenerating) return;
            
            isGenerating = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            // Reset timing if generation was stopped manually
            if (generationStartTime) {
                const duration = (Date.now() - generationStartTime) / 1000;
                addOutput(`‚èπÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${formatDuration(duration)}`, 'warning');
                generationStartTime = null;
            }
            
            // Close event source if exists
            if (window.currentEventSource) {
                window.currentEventSource.close();
                window.currentEventSource = null;
            }
            
            // Call backend API to stop generation
            const requestId = ++lastRequestId;
            fetch('/api/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                addDebug(`req:${requestId} /api/stop status ${response.status}`);
                return response.json();
            })
            .then(data => {
                addOutput(`‚èπÔ∏è [req:${requestId}] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º`, 'warning');
                updateStatus('üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                updateProgress(0);
            })
            .catch(error => {
                addOutput(`‚ùå [req:${requestId}] –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${error.message}`, 'error');
                updateStatus('üü¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                updateProgress(0);
            });
        }
        
        // Initialize
        addOutput('üåê –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û–ø–∏—Å–∞–Ω–∏–π v1.0 - Retro Edition', 'info');
        addOutput('üìä –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∫ —Å–µ—Ä–≤–µ—Ä—É', 'info');
        
        // Close modal on outside click
        document.getElementById('previewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePreview();
            }
        });
        
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });
    </script>
</body>
</html>
